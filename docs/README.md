# Orders Analytics (SQL → Python → Excel)

Данный репозиторий содержит решение тестового задания, включающее SQL-запрос для извлечения и дедупликации данных, а также Python-скрипт для автоматической сборки аналитического отчета в формате Excel.

### Структура проекта
```
├── data/
│ ├── generate_data.py
│ └── (*.csv)
├── docs/
│ └── README.md
├── excel/
│ └── Report.xlsx
├── py/
│ └── build_report.py
└── sql/
  └── export.sql
```

## Инструкция по запуску

Для сборки отчета необходимо выполнить следующие шаги из корневой директории проекта.

### 1. Установка зависимостей
Проект требует Python 3.10+ и несколько библиотек. Установите их с помощью pip:
```
pip install pandas openpyxl
```
### 2. Генерация тестовых данных
Выполните скрипт generate_data.py, указав ваш e-mail в качестве seed для генератора данных.
```
python data/generate_data.py --email your.email@example.com --orders 8000 --days 150
```
В результате в папке data/ будут созданы три CSV-файла: sellers.csv, orders.csv, order_items.csv.
### 3. Сборка отчета
Запустите основной скрипт build_report.py. По умолчанию он проанализирует данные за последние 90 дней и сохранит отчет в excel/Report.xlsx.
```
python py/build_report.py --days 90 --out excel/Report.xlsx
```

## Технические решения и особенности
Для ускорения выполнения запроса были использованы следующие индексы, которые создаются перед основным SELECT:
1) idx_orders_external_id: Ключевой индекс для оконной функции PARTITION BY external_id при дедупликации.
2) idx_orders_delivered_at, idx_orders_updated_at: Ускоряют сортировку ORDER BY внутри оконной функции.
3) idx_orders_date: Ускоряет фильтрацию по периоду в WHERE.
4) idx_order_items_order_id, idx_orders_seller_id: Ускоряют операции JOIN с таблицами позиций и продавцов.

**Логика дедупликации реализована через CTE и оконную функцию ROW_NUMBER()**, что позволяет гибко настроить приоритет выбора "лучшей" записи заказа согласно правилам ТЗ.

## Особенности данных
Скрипт-генератор имитирует реальные данные с возможными аномалиями, такими как:
Нулевое или отрицательное количество товара (qty).
Отрицательная маржа из-за ошибок ценообразования.
Заказы с seller_id, которого нет в справочнике продавцов.

**Все эти аномалии успешно отлавливаются и отображаются на листе Checks в итоговом отчете.**

## Использование ИИ
При выполнении задания применялся ИИ-ассистент в роли "парного программиста" для ускорения разработки, отладки и прояснения концепций. Весь код был полностью разобран и изучен.

**Фрагмент, сгенерированный с помощью ИИ:**
Основная помощь была получена при написании цикла для вывода данных на лист Checks. После того как логика самих проверок была определена и реализована (результаты помещены в словарь checks), был сформулирован промпт для генерации цикла, который бы аккуратно выводил эти данные на лист Excel с условным форматированием.

